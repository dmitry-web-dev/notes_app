name: Security Check

on: [pull_request]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
           python-version: '3.10'
      
      - name: Install Bandit
        run: pip install bandit
      
      - name: Run Bandit scan
        run: |
          echo "Scanning project files..."
          
          # Сканируем ТОЛЬКО наши файлы
          if [ -f ".bandit" ]; then
            bandit -c .bandit .
          else
            bandit app.py tests/test_security.py --severity-level high
          fi
          
          if [ $? -ne 0 ]; then
            echo "::error::MERGE BLOCKED: Security vulnerabilities found!"
            exit 1
          fi
      
      - name: Check debug mode
        run: |
          echo "Checking debug mode..."
          if grep -q "debug\s*=\s*True" app.py; then
            echo "::error::MERGE BLOCKED: debug=True found!"
            exit 1
          fi
      
      - name: Check debug mode
        run: |
          echo "Checking debug mode..."
          # Только app.py
          if grep -q "debug\s*=\s*True" app.py; then
            echo "::error::debug=True found!"
            exit 1
          fi
          echo "✅ Debug check passed"